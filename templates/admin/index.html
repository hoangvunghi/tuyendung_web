{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
  {{ block.super }}
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      
      --thang-long-scarlet: #F32409;
      --thang-long-indigo: #000066;
      --thang-long-mid-blue: #0623A4;
      --thang-long-light-blue: #0044FF;
      --thang-long-cultured-white: #F5F5F7;
      
      --primary-color: var(--thang-long-scarlet);
      --secondary-color: var(--thang-long-indigo);
      --accent-color: var(--thang-long-mid-blue);
      --light-color: var(--thang-long-light-blue);
      --background-color: var(--thang-long-cultured-white);
    }
    
    .dashboard-wrapper {
      background-color: var(--background-color);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    
    .dashboard-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .dashboard-header-icon {
      background-color: var(--primary-color);
      color: var(--background-color);
      border-radius: 50%;
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      box-shadow: var(--card-shadow);
    }
    
    .dashboard-header-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--secondary-color);
    }
    
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--background-color);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--hover-shadow);
    }
    
    .stat-card.primary {
      border-left: 4px solid var(--primary-color);
    }
    
    .stat-card.secondary {
      border-left: 4px solid var(--secondary-color);
    }
    
    .stat-card.accent {
      border-left: 4px solid var(--accent-color);
    }
    
    .stat-card.light {
      border-left: 4px solid var(--light-color);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .stat-card.primary .stat-value {
      color: var(--primary-color);
    }
    
    .stat-card.secondary .stat-value {
      color: var(--secondary-color);
    }
    
    .stat-card.accent .stat-value {
      color: var(--accent-color);
    }
    
    .stat-card.light .stat-value {
      color: var(--light-color);
    }
    
    .stat-label {
      color: var(--secondary-color);
      font-size: 0.875rem;
      opacity: 0.8;
    }
    
    .stat-icon {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      opacity: 0.2;
    }
    
    .stat-card.primary .stat-icon {
      color: var(--primary-color);
    }
    
    .stat-card.secondary .stat-icon {
      color: var(--secondary-color);
    }
    
    .stat-card.accent .stat-icon {
      color: var(--accent-color);
    }
    
    .stat-card.light .stat-icon {
      color: var(--light-color);
    }
    
    .dashboard-charts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(480px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .chart-container {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      min-height: 350px;
      position: relative;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(229, 231, 235, 0.5);
    }
    
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }
    
    .chart-wrapper {
      position: relative;
      height: calc(100% - 40px);
    }
    
    .dashboard-section {
      margin-bottom: 2rem;
    }
    
    .dashboard-section-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
    }
    
    .dashboard-section-title .material-icons {
      margin-right: 0.5rem;
      opacity: 0.8;
    }
    
    @media (max-width: 768px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
      }
      
      .dashboard-charts {
        grid-template-columns: 1fr;
      }
    }

    .color-primary { color: var(--primary-color); }
    .color-info { color: var(--info-color); }
    .color-success { color: var(--success-color); }
    .color-warning { color: var(--warning-color); }
    .color-error { color: var(--error-color); }
    .color-indigo { color: var(--indigo-color); }
    .color-orange { color: var(--orange-color); }
    .color-purple { color: var(--purple-color); }

    .grid-2col {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .span-2 {
      grid-column: span 2;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 1.2rem;
      color: #64748B;
    }
    
    /* Thêm lớp để kiểm tra lỗi */
    .debug-info {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
  </style>
  
  <!-- Thêm Chart.js vào block extrastyle để đảm bảo nó được tải -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
{% endblock %}

{% block coltype %}full{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block nav-sidebar %}
  {{ block.super }}
{% endblock %}

{% block content %}
  <div id="content-main">
    <div class="dashboard-wrapper">
      <div class="dashboard-header">
        <div class="dashboard-header-icon">
          <span class="material-icons">dashboard</span>
        </div>
        <h1 class="dashboard-header-title">{% translate 'Bảng Điều Khiển Tuyển Dụng' %}</h1>
      </div>
      
      <!-- Debug info -->
      <div id="debug-container" class="debug-info"></div>
      
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">insert_chart</span>
          {% translate 'Thống Kê Tổng Quan' %}
        </h2>
        <div class="dashboard-stats" id="stats-container">
          <!-- Dữ liệu thống kê sẽ được hiển thị ở đây -->
          <div class="loading-spinner">Đang tải dữ liệu...</div>
        </div>
      </div>

      <!-- Thống kê người dùng -->
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">people</span>
          {% translate 'Thống Kê Người Dùng' %}
        </h2>
        <div class="dashboard-charts" id="user-stats-container">
          <div class="chart-container">
            <h3>Hoạt động người dùng theo vai trò</h3>
            <div class="chart-wrapper">
              <canvas id="user-role-activity-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Tần suất đăng nhập</h3>
            <div class="chart-wrapper">
              <canvas id="login-frequency-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Xu hướng đăng ký theo nguồn</h3>
            <div class="chart-wrapper">
              <canvas id="registration-source-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Tỷ lệ chuyển đổi người dùng Premium</h3>
            <div class="chart-wrapper">
              <canvas id="premium-conversion-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Thống kê doanh nghiệp -->
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">business</span>
          {% translate 'Thống Kê Doanh Nghiệp' %}
        </h2>
        <div class="dashboard-charts" id="enterprise-stats-container">
          <div class="chart-container">
            <h3>Hoạt động doanh nghiệp</h3>
            <div class="chart-wrapper">
              <canvas id="enterprise-activity-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Top doanh nghiệp theo số lượng ứng viên</h3>
            <div class="chart-wrapper">
              <canvas id="top-enterprises-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Trạng thái xác thực doanh nghiệp</h3>
            <div class="chart-wrapper">
              <canvas id="enterprise-verification-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Phân bố doanh nghiệp theo ngành</h3>
            <div class="chart-wrapper">
              <canvas id="enterprise-industry-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Thống kê bài đăng -->
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">work</span>
          {% translate 'Thống Kê Bài Đăng' %}
        </h2>
        <div class="dashboard-charts" id="job-stats-container">
          <div class="chart-container">
            <h3>Lượt xem và ứng tuyển theo lĩnh vực</h3>
            <div class="chart-wrapper">
              <canvas id="job-field-stats-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Thời gian tuyển dụng theo lĩnh vực</h3>
            <div class="chart-wrapper">
              <canvas id="job-fill-time-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Phân bố địa điểm và mức lương</h3>
            <div class="chart-wrapper">
              <canvas id="job-location-salary-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Loại hình công việc</h3>
            <div class="chart-wrapper">
              <canvas id="job-type-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Thống kê CV và ứng tuyển -->
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">description</span>
          {% translate 'Thống Kê CV & Ứng Tuyển' %}
        </h2>
        <div class="dashboard-charts" id="cv-stats-container">
          <div class="chart-container">
            <h3>Xu hướng nộp CV theo lĩnh vực</h3>
            <div class="chart-wrapper">
              <canvas id="cv-submission-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Thời gian xử lý CV</h3>
            <div class="chart-wrapper">
              <canvas id="cv-processing-time-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Tỷ lệ thành công của ứng tuyển</h3>
            <div class="chart-wrapper">
              <canvas id="application-success-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Kỹ năng phổ biến theo lĩnh vực</h3>
            <div class="chart-wrapper">
              <canvas id="top-skills-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Thống kê tài chính -->
      <div class="dashboard-section">
        <h2 class="dashboard-section-title">
          <span class="material-icons">monetization_on</span>
          {% translate 'Thống Kê Tài Chính' %}
        </h2>
        <div class="dashboard-charts" id="financial-stats-container">
          <div class="chart-container">
            <h3>Doanh thu theo gói Premium</h3>
            <div class="chart-wrapper">
              <canvas id="revenue-by-package-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Doanh thu trung bình trên mỗi người dùng</h3>
            <div class="chart-wrapper">
              <canvas id="arppu-chart"></canvas>
            </div>
          </div>
          <div class="chart-container">
            <h3>Tỷ lệ giao dịch thành công</h3>
            <div class="chart-wrapper">
              <canvas id="transaction-success-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <!-- Chuyển mã JavaScript ra khỏi block extrajs và đặt trực tiếp trong block content -->
  <script>
    console.log('Script đã được tải');
    
    // Function hiển thị thông báo debug
    function showDebug(message) {
      const debugContainer = document.getElementById('debug-container');
      if (debugContainer) {
        debugContainer.style.display = 'block';
        debugContainer.innerHTML += `<p>${message}</p>`;
        console.log(message);
      }
    }
    
    try {
      // Dữ liệu mẫu để dự phòng nếu API không hoạt động
      const fallbackData = {
        "stats": [
          {
            "label": "Tổng số tài khoản",
            "value": 108,
            "color": "primary",
            "icon": "person"
          },
          {
            "label": "Tổng số hồ sơ",
            "value": 106,
            "color": "info",
            "icon": "folder"
          },
          {
            "label": "Doanh nghiệp",
            "value": 102,
            "color": "success",
            "icon": "business"
          },
          {
            "label": "Bài đăng",
            "value": 72,
            "color": "warning",
            "icon": "article"
          },
          {
            "label": "CV đã nhận",
            "value": 21,
            "color": "indigo",
            "icon": "description"
          },
          {
            "label": "Phỏng vấn",
            "value": 0,
            "color": "orange",
            "icon": "event"
          },
          {
            "label": "Doanh thu",
            "value": "8,961,000 VNĐ",
            "color": "error",
            "icon": "monetization_on"
          },
          {
            "label": "Người dùng Premium",
            "value": 2,
            "color": "purple",
            "icon": "star"
          }
        ],
        "user_stats": {
          "role_activity": {
            "labels": ["Ứng viên", "Doanh nghiệp"],
            "datasets": [
              {
                "label": "Người dùng hoạt động",
                "data": [85, 45],
                "color": "primary"
              },
              {
                "label": "Người dùng mới",
                "data": [12, 8],
                "color": "success"
              }
            ]
          },
          "login_frequency": {
            "labels": ["Hàng ngày", "Hàng tuần", "Hàng tháng"],
            "datasets": [
              {
                "label": "Tần suất đăng nhập",
                "data": [65, 25, 10],
                "color": "info"
              }
            ]
          },
          "registration_source": {
            "labels": ["Email", "Google", "Facebook"],
            "datasets": [
              {
                "label": "Nguồn đăng ký",
                "data": [45, 35, 20],
                "color": "warning"
              }
            ]
          },
          "premium_conversion": {
            "labels": ["Chuyển đổi", "Giữ chân"],
            "datasets": [
              {
                "label": "Tỷ lệ Premium",
                "data": [15, 85],
                "color": "purple"
              }
            ]
          }
        },
        "enterprise_stats": {
          "activity": {
            "labels": ["Bài đăng", "Xem CV", "Ứng tuyển"],
            "datasets": [
              {
                "label": "Hoạt động",
                "data": [72, 156, 89],
                "color": "success"
              }
            ]
          },
          "top_enterprises": {
            "labels": ["DN A", "DN B", "DN C", "DN D", "DN E"],
            "datasets": [
              {
                "label": "Số lượng ứng viên",
                "data": [45, 38, 32, 28, 25],
                "color": "info"
              }
            ]
          },
          "verification": {
            "labels": ["Đã xác thực", "Đang chờ", "Chưa xác thực"],
            "datasets": [
              {
                "data": [65, 25, 10],
                "backgroundColor": [
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(251, 191, 36, 0.8)",
                  "rgba(239, 68, 68, 0.8)"
                ]
              }
            ]
          },
          "industry": {
            "labels": ["CNTT", "Tài chính", "Bán lẻ", "Sản xuất", "Khác"],
            "datasets": [
              {
                "label": "Phân bố ngành",
                "data": [35, 25, 20, 15, 5],
                "color": "warning"
              }
            ]
          }
        },
        "job_stats": {
          "field_stats": {
            "labels": ["CNTT", "Marketing", "Kinh doanh", "Kỹ thuật"],
            "datasets": [
              {
                "label": "Lượt xem",
                "data": [1200, 800, 600, 400],
                "color": "primary"
              },
              {
                "label": "Ứng tuyển",
                "data": [150, 100, 80, 60],
                "color": "success"
              }
            ]
          },
          "fill_time": {
            "labels": ["CNTT", "Marketing", "Kinh doanh", "Kỹ thuật"],
            "datasets": [
              {
                "label": "Thời gian (ngày)",
                "data": [15, 20, 25, 30],
                "color": "info"
              }
            ]
          },
          "location_salary": {
            "labels": ["HCM", "HN", "ĐN", "HP"],
            "datasets": [
              {
                "label": "Mức lương (triệu)",
                "data": [25, 22, 20, 18],
                "color": "warning"
              }
            ]
          },
          "job_type": {
            "labels": ["Toàn thời gian", "Bán thời gian", "Thực tập", "Hợp đồng"],
            "datasets": [
              {
                "data": [60, 20, 15, 5],
                "backgroundColor": [
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(251, 191, 36, 0.8)",
                  "rgba(139, 92, 246, 0.8)"
                ]
              }
            ]
          }
        },
        "cv_stats": {
          "submission": {
            "labels": ["CNTT", "Marketing", "Kinh doanh", "Kỹ thuật"],
            "datasets": [
              {
                "label": "Số lượng CV",
                "data": [150, 100, 80, 60],
                "color": "primary"
              }
            ]
          },
          "processing_time": {
            "labels": ["< 1 ngày", "1-3 ngày", "3-7 ngày", "> 7 ngày"],
            "datasets": [
              {
                "label": "Thời gian xử lý",
                "data": [40, 35, 20, 5],
                "color": "info"
              }
            ]
          },
          "success_rate": {
            "labels": ["Đã duyệt", "Đang chờ", "Từ chối"],
            "datasets": [
              {
                "data": [60, 30, 10],
                "backgroundColor": [
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(251, 191, 36, 0.8)",
                  "rgba(239, 68, 68, 0.8)"
                ]
              }
            ]
          },
          "top_skills": {
            "labels": ["Python", "Java", "React", "Node.js", "SQL"],
            "datasets": [
              {
                "label": "Tần suất xuất hiện",
                "data": [85, 75, 65, 55, 45],
                "color": "warning"
              }
            ]
          }
        },
        "financial_stats": {
          "revenue_by_package": {
            "labels": ["Cơ bản", "Nâng cao", "Premium", "Enterprise"],
            "datasets": [
              {
                "label": "Doanh thu (triệu)",
                "data": [5, 8, 12, 15],
                "color": "success"
              }
            ]
          },
          "arppu": {
            "labels": ["Q1", "Q2", "Q3", "Q4"],
            "datasets": [
              {
                "label": "ARPPU (triệu)",
                "data": [2.5, 3.0, 3.5, 4.0],
                "color": "primary"
              }
            ]
          },
          "transaction_success": {
            "labels": ["Thành công", "Thất bại"],
            "datasets": [
              {
                "data": [95, 5],
                "backgroundColor": [
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(239, 68, 68, 0.8)"
                ]
              }
            ]
          },
          "revenue_by_payment": {
            "labels": ["Chuyển khoản", "Thẻ tín dụng", "Ví điện tử"],
            "datasets": [
              {
                "label": "Doanh thu (triệu)",
                "data": [15, 10, 5],
                "color": "info"
              }
            ]
          }
        },
        "system_stats": {
          "api_response": {
            "labels": ["< 100ms", "100-500ms", "500-1000ms", "> 1000ms"],
            "datasets": [
              {
                "label": "Thời gian phản hồi",
                "data": [70, 20, 7, 3],
                "color": "success"
              }
            ]
          },
          "system_load": {
            "labels": ["00:00", "06:00", "12:00", "18:00", "24:00"],
            "datasets": [
              {
                "label": "Tải hệ thống (%)",
                "data": [30, 40, 80, 60, 35],
                "color": "warning"
              }
            ]
          },
          "device_distribution": {
            "labels": ["Desktop", "Mobile", "Tablet"],
            "datasets": [
              {
                "data": [60, 35, 5],
                "backgroundColor": [
                  "rgba(59, 130, 246, 0.8)",
                  "rgba(34, 197, 94, 0.8)",
                  "rgba(251, 191, 36, 0.8)"
                ]
              }
            ]
          },
          "search_performance": {
            "labels": ["< 1s", "1-2s", "2-3s", "> 3s"],
            "datasets": [
              {
                "label": "Thời gian tìm kiếm",
                "data": [80, 15, 4, 1],
                "color": "info"
              }
            ]
          }
        }
      };

      // Thiết lập màu sắc và font chung cho biểu đồ
      Chart.defaults.font.family = "'Be Vietnam Pro', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif";
      Chart.defaults.font.size = 13;
      Chart.defaults.color = '#64748B';
      
      const colorMap = {
        primary: { borderColor: 'rgb(168, 85, 247)', backgroundColor: 'rgba(168, 85, 247, 0.1)' },
        info: { borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)' },
        success: { borderColor: 'rgb(34, 197, 94)', backgroundColor: 'rgba(34, 197, 94, 0.1)' },
        warning: { borderColor: 'rgb(251, 191, 36)', backgroundColor: 'rgba(251, 191, 36, 0.1)' },
        error: { borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)' },
        indigo: { borderColor: 'rgb(99, 102, 241)', backgroundColor: 'rgba(99, 102, 241, 0.1)' },
        orange: { borderColor: 'rgb(234, 88, 12)', backgroundColor: 'rgba(234, 88, 12, 0.1)' },
        purple: { borderColor: 'rgb(139, 92, 246)', backgroundColor: 'rgba(139, 92, 246, 0.1)' },
      };
      
      // Định dạng icon để hiển thị đẹp hơn
      const iconMap = {
          person: '<i class="fas fa-user"></i>',
          folder: '<i class="fas fa-folder"></i>',
          business: '<i class="fas fa-building"></i>',
          article: '<i class="fas fa-file-alt"></i>',
          description: '<i class="fas fa-file-signature"></i>',
          event: '<i class="fas fa-calendar-alt"></i>',
          monetization_on: '<i class="fas fa-dollar-sign"></i>',
          star: '<i class="fas fa-crown"></i>'
      };
      
      // Fetch dữ liệu từ API
      async function fetchDashboardData() {
        try {
          const response = await fetch('/api/dashboard/stats/');
          if (!response.ok) {
            throw new Error(`Lỗi khi tải dữ liệu: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch (error) {
          showDebug(`Lỗi khi tải dữ liệu: ${error.message}`);
          return fallbackData;
        }
      }
      
      // Hiển thị thống kê
      function renderStats(stats) {
        const statsContainer = document.getElementById('stats-container');
        if (!statsContainer) return;
        
        statsContainer.innerHTML = '';
        
        stats.forEach(stat => {
          const icon = iconMap[stat.icon] || `<i class="material-icons">${stat.icon}</i>`;
          
          const statCard = `
            <a href="#" class="stat-card color-${stat.color}">
              <div class="stat-icon">
                ${icon}
              </div>
              <div class="stat-value">${stat.value}</div>
              <div class="stat-label">${stat.label}</div>
            </a>
          `;
          statsContainer.insertAdjacentHTML('beforeend', statCard);
        });
      }
      
      // Tạo biểu đồ
      function initializeCharts(data) {
        try {
          // Thống kê người dùng
          try {
            initializeUserCharts(data.user_stats);
          } catch (error) {
            showDebug(`Lỗi khi khởi tạo biểu đồ người dùng: ${error.message}`);
          }
          try {
            initializeEnterpriseCharts(data.enterprise_stats);
          } catch (error) {
            showDebug(`Lỗi khi khởi tạo biểu đồ doanh nghiệp: ${error.message}`);
          }
          try {
          // Thống kê bài đăng
          initializeJobCharts(data.job_stats);
          } catch (error) {
            showDebug(`Lỗi khi khởi tạo biểu đồ bài đăng: ${error.message}`);
          }
          try {
          // Thống kê CV và ứng tuyển
          initializeCVCharts(data.cv_stats);
          } catch (error) {
            showDebug(`Lỗi khi khởi tạo biểu đồ CV và ứng tuyển: ${error.message}`);
          }
          
          // Thống kê tài chính
          try { 
            initializeFinancialCharts(data.financial_stats);
          } catch (error) {
            showDebug(`Lỗi khi khởi tạo biểu đồ tài chính: ${error.message}`);
          }
          
        } catch (error) {
          showDebug(`Lỗi khi khởi tạo biểu đồ: ${error.message}`);
        }
      }
      
      // Khởi tạo biểu đồ thống kê người dùng
      function initializeUserCharts(userStats) {
        // Hoạt động người dùng theo vai trò
        const userRoleActivityCtx = document.getElementById('user-role-activity-chart')?.getContext('2d');
        if (userRoleActivityCtx) {
          new Chart(userRoleActivityCtx, {
            type: 'bar',
            data: {
              labels: userStats.role_activity.labels,
              datasets: userStats.role_activity.datasets.map(dataset => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: colorMap[dataset.color].borderColor,
                backgroundColor: colorMap[dataset.color].backgroundColor,
                borderWidth: 2
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Tần suất đăng nhập
        const loginFrequencyCtx = document.getElementById('login-frequency-chart')?.getContext('2d');
        if (loginFrequencyCtx) {
          new Chart(loginFrequencyCtx, {
            type: 'doughnut',
            data: {
              labels: userStats.login_frequency.labels,
              datasets: [{
                data: userStats.login_frequency.datasets[0].data,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(251, 191, 36, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Xu hướng đăng ký theo nguồn
        const registrationSourceCtx = document.getElementById('registration-source-chart')?.getContext('2d');
        if (registrationSourceCtx) {
          new Chart(registrationSourceCtx, {
            type: 'pie',
            data: {
              labels: userStats.registration_source.labels,
              datasets: [{
                data: userStats.registration_source.datasets[0].data,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(251, 191, 36, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Tỷ lệ chuyển đổi Premium
        const premiumConversionCtx = document.getElementById('premium-conversion-chart')?.getContext('2d');
        if (premiumConversionCtx) {
          new Chart(premiumConversionCtx, {
            type: 'doughnut',
            data: {
              labels: userStats.premium_conversion.labels,
              datasets: [{
                data: userStats.premium_conversion.datasets[0].data,
                backgroundColor: [
                  'rgba(139, 92, 246, 0.8)',
                  'rgba(59, 130, 246, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Khởi tạo biểu đồ thống kê doanh nghiệp
      function initializeEnterpriseCharts(enterpriseStats) {
        // Hoạt động doanh nghiệp
        const enterpriseActivityCtx = document.getElementById('enterprise-activity-chart')?.getContext('2d');
        if (enterpriseActivityCtx) {
          new Chart(enterpriseActivityCtx, {
            type: 'bar',
            data: {
              labels: enterpriseStats.activity.labels,
              datasets: [{
                label: enterpriseStats.activity.datasets[0].label,
                data: enterpriseStats.activity.datasets[0].data,
                borderColor: colorMap[enterpriseStats.activity.datasets[0].color].borderColor,
                backgroundColor: colorMap[enterpriseStats.activity.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Top doanh nghiệp
        const topEnterprisesCtx = document.getElementById('top-enterprises-chart')?.getContext('2d');
        if (topEnterprisesCtx) {
          new Chart(topEnterprisesCtx, {
            type: 'bar',
            data: {
              labels: enterpriseStats.top_enterprises.labels,
              datasets: [{
                label: enterpriseStats.top_enterprises.datasets[0].label,
                data: enterpriseStats.top_enterprises.datasets[0].data,
                borderColor: colorMap[enterpriseStats.top_enterprises.datasets[0].color].borderColor,
                backgroundColor: colorMap[enterpriseStats.top_enterprises.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Trạng thái xác thực
        const verificationCtx = document.getElementById('enterprise-verification-chart')?.getContext('2d');
        if (verificationCtx) {
          new Chart(verificationCtx, {
            type: 'pie',
            data: {
              labels: enterpriseStats.verification.labels,
              datasets: [{
                data: enterpriseStats.verification.datasets[0].data,
                backgroundColor: enterpriseStats.verification.datasets[0].backgroundColor
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Phân bố ngành
        const industryCtx = document.getElementById('enterprise-industry-chart')?.getContext('2d');
        if (industryCtx) {
          new Chart(industryCtx, {
            type: 'doughnut',
            data: {
              labels: enterpriseStats.industry.labels,
              datasets: [{
                label: enterpriseStats.industry.datasets[0].label,
                data: enterpriseStats.industry.datasets[0].data,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(251, 191, 36, 0.8)',
                  'rgba(139, 92, 246, 0.8)',
                  'rgba(239, 68, 68, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Khởi tạo biểu đồ thống kê bài đăng
      function initializeJobCharts(jobStats) {
        // Lượt xem và ứng tuyển theo lĩnh vực
        const fieldStatsCtx = document.getElementById('job-field-stats-chart')?.getContext('2d');
        if (fieldStatsCtx) {
          new Chart(fieldStatsCtx, {
            type: 'bar',
            data: {
              labels: jobStats.field_stats.labels,
              datasets: jobStats.field_stats.datasets.map(dataset => ({
                label: dataset.label,
                data: dataset.data,
                borderColor: colorMap[dataset.color].borderColor,
                backgroundColor: colorMap[dataset.color].backgroundColor,
                borderWidth: 2
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Thời gian tuyển dụng
        const fillTimeCtx = document.getElementById('job-fill-time-chart')?.getContext('2d');
        if (fillTimeCtx) {
          new Chart(fillTimeCtx, {
            type: 'line',
            data: {
              labels: jobStats.fill_time.labels,
              datasets: [{
                label: jobStats.fill_time.datasets[0].label,
                data: jobStats.fill_time.datasets[0].data,
                borderColor: colorMap[jobStats.fill_time.datasets[0].color].borderColor,
                backgroundColor: colorMap[jobStats.fill_time.datasets[0].color].backgroundColor,
                borderWidth: 2,
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Phân bố địa điểm và mức lương
        const locationSalaryCtx = document.getElementById('job-location-salary-chart')?.getContext('2d');
        if (locationSalaryCtx) {
          new Chart(locationSalaryCtx, {
            type: 'bar',
            data: {
              labels: jobStats.location_salary.labels,
              datasets: [{
                label: jobStats.location_salary.datasets[0].label,
                data: jobStats.location_salary.datasets[0].data,
                borderColor: colorMap[jobStats.location_salary.datasets[0].color].borderColor,
                backgroundColor: colorMap[jobStats.location_salary.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Loại hình công việc
        const jobTypeCtx = document.getElementById('job-type-chart')?.getContext('2d');
        if (jobTypeCtx) {
          new Chart(jobTypeCtx, {
            type: 'pie',
            data: {
              labels: jobStats.job_type.labels,
              datasets: [{
                data: jobStats.job_type.datasets[0].data,
                backgroundColor: jobStats.job_type.datasets[0].backgroundColor
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Khởi tạo biểu đồ thống kê CV và ứng tuyển
      function initializeCVCharts(cvStats) {
        // Xu hướng nộp CV
        const submissionCtx = document.getElementById('cv-submission-chart')?.getContext('2d');
        if (submissionCtx) {
          new Chart(submissionCtx, {
            type: 'bar',
            data: {
              labels: cvStats.submission.labels,
              datasets: [{
                label: cvStats.submission.datasets[0].label,
                data: cvStats.submission.datasets[0].data,
                borderColor: colorMap[cvStats.submission.datasets[0].color].borderColor,
                backgroundColor: colorMap[cvStats.submission.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Thời gian xử lý CV
        const processingTimeCtx = document.getElementById('cv-processing-time-chart')?.getContext('2d');
        if (processingTimeCtx) {
          new Chart(processingTimeCtx, {
            type: 'doughnut',
            data: {
              labels: cvStats.processing_time.labels,
              datasets: [{
                label: cvStats.processing_time.datasets[0].label,
                data: cvStats.processing_time.datasets[0].data,
                backgroundColor: [
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(251, 191, 36, 0.8)',
                  'rgba(239, 68, 68, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Tỷ lệ thành công
        const successRateCtx = document.getElementById('application-success-chart')?.getContext('2d');
        if (successRateCtx) {
          new Chart(successRateCtx, {
            type: 'pie',
            data: {
              labels: cvStats.success_rate.labels,
              datasets: [{
                data: cvStats.success_rate.datasets[0].data,
                backgroundColor: cvStats.success_rate.datasets[0].backgroundColor
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Kỹ năng phổ biến
        const topSkillsCtx = document.getElementById('top-skills-chart')?.getContext('2d');
        if (topSkillsCtx) {
          new Chart(topSkillsCtx, {
            type: 'bar',
            data: {
              labels: cvStats.top_skills.labels,
              datasets: [{
                label: cvStats.top_skills.datasets[0].label,
                data: cvStats.top_skills.datasets[0].data,
                borderColor: colorMap[cvStats.top_skills.datasets[0].color].borderColor,
                backgroundColor: colorMap[cvStats.top_skills.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }
      
      // Khởi tạo biểu đồ thống kê tài chính
      function initializeFinancialCharts(financialStats) {
        // Doanh thu theo gói
        const revenueByPackageCtx = document.getElementById('revenue-by-package-chart')?.getContext('2d');
        if (revenueByPackageCtx) {
          new Chart(revenueByPackageCtx, {
            type: 'bar',
            data: {
              labels: financialStats.revenue_by_package.labels,
              datasets: [{
                label: financialStats.revenue_by_package.datasets[0].label,
                data: financialStats.revenue_by_package.datasets[0].data,
                borderColor: colorMap[financialStats.revenue_by_package.datasets[0].color].borderColor,
                backgroundColor: colorMap[financialStats.revenue_by_package.datasets[0].color].backgroundColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.dataset.label + ': ' + context.parsed.y + ' triệu';
                    }
                  }
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  color: '#222',
                  font: { weight: 'bold' },
                  formatter: function(value) {
                    return value;
                  }
                }
              },
              scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Doanh thu (triệu)' } }
              }
            },
            plugins: window.ChartDataLabels ? [ChartDataLabels] : []
          });
        }
        
        // ARPPU
        const arppuCtx = document.getElementById('arppu-chart')?.getContext('2d');
        if (arppuCtx) {
          new Chart(arppuCtx, {
            type: 'line',
            data: {
              labels: financialStats.arppu.labels,
              datasets: [{
                label: financialStats.arppu.datasets[0].label,
                data: financialStats.arppu.datasets[0].data,
                borderColor: colorMap[financialStats.arppu.datasets[0].color].borderColor,
                backgroundColor: colorMap[financialStats.arppu.datasets[0].color].backgroundColor,
                borderWidth: 2,
                fill: false
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
        
        // Tỷ lệ giao dịch thành công
        const transactionSuccessCtx = document.getElementById('transaction-success-chart')?.getContext('2d');
        if (transactionSuccessCtx) {
          new Chart(transactionSuccessCtx, {
            type: 'doughnut',
            data: {
              labels: financialStats.transaction_success.labels,
              datasets: [{
                data: financialStats.transaction_success.datasets[0].data,
                backgroundColor: financialStats.transaction_success.datasets[0].backgroundColor
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
        
        // Doanh thu theo phương thức thanh toán
        const revenueByPaymentCtx = document.getElementById('revenue-by-payment-chart')?.getContext('2d');
        if (revenueByPaymentCtx) {
          new Chart(revenueByPaymentCtx, {
            type: 'pie',
            data: {
              labels: financialStats.revenue_by_payment.labels,
              datasets: [{
                label: financialStats.revenue_by_payment.datasets[0].label,
                data: financialStats.revenue_by_payment.datasets[0].data,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(251, 191, 36, 0.8)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        }
      }
      
      // Khởi tạo dashboard
      async function initializeDashboard() {
        try {
          // Fetch dữ liệu
          const dashboardData = await fetchDashboardData();
          
          // Hiển thị thống kê
          renderStats(dashboardData.stats);
          
          // Hiển thị biểu đồ
          initializeCharts(dashboardData);
          
        } catch (error) {
          showDebug(`Lỗi khi khởi tạo dashboard: ${error.message}`);
        }
      }
      
      // Gọi hàm khởi tạo dashboard khi trang tải xong
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeDashboard);
      } else {
        initializeDashboard();
      }
      
    } catch (error) {
      showDebug(`Lỗi không xác định: ${error.message}`);
    }
  </script>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <!-- Block extrajs vẫn được giữ để tương thích với template cha -->
{% endblock %}